FROM debian:12-slim

RUN apt-get update && apt-get install -y --no-install-recommends curl ca-certificates git gnupg apt-transport-https libatomic1
RUN install -dm 755 /etc/apt/keyrings
RUN curl -fSs https://mise.jdx.dev/gpg-key.pub | tee /etc/apt/keyrings/mise-archive-keyring.pub >/dev/null
RUN arch=$(dpkg --print-architecture) && echo "deb [signed-by=/etc/apt/keyrings/mise-archive-keyring.pub arch=$arch] https://mise.jdx.dev/deb stable main" | tee /etc/apt/sources.list.d/mise.list
RUN apt-get update && apt-get install -y mise
RUN rm -rf /var/lib/apt/lists/*

RUN groupadd -r agent && useradd -m -r -u 1000 -g agent -s /bin/bash agent
ENV HOME=/home/agent
ENV PATH="/home/agent/.local/share/mise/shims:/home/agent/.local/bin:${PATH}"

RUN mkdir -p /home/agent/.config/mise
LABEL com.mheap.agent-en-place.python="3.12.0"
LABEL com.mheap.agent-en-place.node="20.10.0"
LABEL com.mheap.agent-en-place.claude="latest"
WORKDIR /home/agent
COPY mise.toml /home/agent/.config/mise/config.toml
RUN chown agent:agent /home/agent/.config/mise/config.toml
COPY assets/agent-entrypoint.sh /usr/local/bin/agent-entrypoint
RUN chmod +x /usr/local/bin/agent-entrypoint
USER agent
RUN mise trust
RUN mise install
RUN printf 'export PATH="/home/agent/.local/share/mise/shims:/home/agent/.local/bin:$PATH"\n' > /home/agent/.bashrc
RUN printf 'source ~/.bashrc\n' > /home/agent/.bash_profile
WORKDIR /workdir
ENTRYPOINT ["/bin/bash", "/usr/local/bin/agent-entrypoint"]
